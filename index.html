<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#00a859" />
  <meta name="description" content="App para gestionar conductores por zonas" />
  <title>Control Conductores</title>

  <!-- Manifest PWA (inline) -->
  <link rel="manifest" href="data:application/json,{%22name%22:%22Control%20de%20Conductores%22,%22short_name%22:%22Conductores%22,%22start_url%22:%22.%2F%22,%22display%22:%22standalone%22,%22background_color%22:%22%2300a859%22,%22theme_color%22:%22%2300a859%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20fill='%2300a859'%20width='192'%20height='192'/%3E%3Ctext%20x='50%25'%20y='56%25'%20font-size='92'%20fill='white'%20text-anchor='middle'%20dominant-baseline='middle'%20font-weight='800'%3EC%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #00a859;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }

    /* Lienzo fijo 1000x500 para mantener el layout exacto como tu imagen */
    #captureArea {
      width: 1000px;
      height: 500px;
      position: relative;
      background: #00a859;
      overflow: hidden;
    }

    /* Botones (se ocultan durante la captura) */
    .btn {
      position: absolute;
      left: 20px;
      background: #2f2f2f;
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 6px;
      font-weight: 800;
      letter-spacing: 0.5px;
      cursor: pointer;
      z-index: 30;
    }

    .btn:active { transform: translateY(1px); }

    .btn-capture { top: 110px; }

    .btn-install {
      top: 165px;
      display: none;
      background: #1f6feb;
    }

    .btn-install.show { display: block; }

    /* Zonas de inputs */
    .zone-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 250px;
    }

    .driver-input {
      width: 100%;
      height: 38px;
      border: none;
      outline: none;
      padding: 0 12px;
      font-weight: 800;
      font-size: 16px;
    }

    /* Posiciones (como tu imagen de referencia) */
    .pos-orange { position: absolute; top: 35px; left: 180px; }
    .pos-blue   { position: absolute; top: 35px; left: 450px; }
    .pos-red    { position: absolute; top: 35px; left: 720px; }

    .pos-yellow { position: absolute; top: 245px; left: 35px; }
    .pos-purple { position: absolute; top: 245px; left: 720px; }

    /* Colores */
    .bg-orange { background: #f2b233; color: #111; }
    .bg-blue   { background: #232a9a; color: #fff; }
    .bg-red    { background: #a70f0f; color: #fff; }
    .bg-yellow { background: #fff200; color: #111; }
    .bg-purple { background: #7b1fa2; color: #fff; }

    .bg-orange::placeholder,
    .bg-yellow::placeholder { color: rgba(17,17,17,0.45); }

    .bg-blue::placeholder,
    .bg-red::placeholder,
    .bg-purple::placeholder { color: rgba(255,255,255,0.55); }

    /* Mapa central */
    .map-center {
      position: absolute;
      top: 215px;
      left: 355px;
      width: 310px;
      z-index: 5;
      pointer-events: none;
    }

    .map-center img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Selector de turnos (a la derecha, sin solaparse con rojo) */
    .shift-selector {
      position: absolute;
      top: 45px;
      right: 20px;
      background: #fff;
      padding: 12px 14px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      font-weight: 900;
      font-size: 18px;
      z-index: 25;
    }

    .shift-option { display: flex; align-items: center; gap: 12px; }
    input[type="radio"] { transform: scale(1.6); }

    /* Responsive: si la pantalla es pequeña, se reduce el canvas proporcionalmente */
    .viewport {
      width: min(1000px, calc(100vw - 24px));
    }

    .viewport.scaled #captureArea {
      transform-origin: top left;
    }

    @media (max-width: 1100px) {
      .viewport.scaled #captureArea {
        transform: scale(var(--scale));
      }
    }
  </style>
</head>
<body>
  <div class="viewport scaled" id="viewport">
    <div id="captureArea">
      <button class="btn btn-capture" id="btnCapture" onclick="capture()">CAPTURA</button>
      <button class="btn btn-install" id="btnInstall">INSTALAR</button>

      <!-- Zona Naranja (5) -->
      <div class="zone-grid pos-orange">
        <input type="text" class="driver-input bg-orange" data-zone="orange" data-index="0" />
        <input type="text" class="driver-input bg-orange" data-zone="orange" data-index="1" />
        <input type="text" class="driver-input bg-orange" data-zone="orange" data-index="2" />
        <input type="text" class="driver-input bg-orange" data-zone="orange" data-index="3" />
        <input type="text" class="driver-input bg-orange" data-zone="orange" data-index="4" />
      </div>

      <!-- Zona Azul (5) -->
      <div class="zone-grid pos-blue">
        <input type="text" class="driver-input bg-blue" data-zone="blue" data-index="0" />
        <input type="text" class="driver-input bg-blue" data-zone="blue" data-index="1" />
        <input type="text" class="driver-input bg-blue" data-zone="blue" data-index="2" />
        <input type="text" class="driver-input bg-blue" data-zone="blue" data-index="3" />
        <input type="text" class="driver-input bg-blue" data-zone="blue" data-index="4" />
      </div>

      <!-- Zona Roja (5) -->
      <div class="zone-grid pos-red">
        <input type="text" class="driver-input bg-red" data-zone="red" data-index="0" />
        <input type="text" class="driver-input bg-red" data-zone="red" data-index="1" />
        <input type="text" class="driver-input bg-red" data-zone="red" data-index="2" />
        <input type="text" class="driver-input bg-red" data-zone="red" data-index="3" />
        <input type="text" class="driver-input bg-red" data-zone="red" data-index="4" />
      </div>

      <!-- Selector de turno -->
      <div class="shift-selector">
        <label class="shift-option"><input type="radio" name="turno" value="manana"> MAÑANA</label>
        <label class="shift-option"><input type="radio" name="turno" value="tarde"> TARDE</label>
        <label class="shift-option"><input type="radio" name="turno" value="noche"> NOCHE</label>
      </div>

      <!-- Zona Amarilla (EXT = 6) -->
      <div class="zone-grid pos-yellow">
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="0" />
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="1" />
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="2" />
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="3" />
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="4" />
        <input type="text" class="driver-input bg-yellow" data-zone="yellow" data-index="5" />
      </div>

      <!-- Mapa central (usando tu MAPA.png) -->
      <div class="map-center">
        <img src="MAPA.png" alt="Mapa" />
      </div>

      <!-- Zona Púrpura (5) -->
      <div class="zone-grid pos-purple">
        <input type="text" class="driver-input bg-purple" data-zone="purple" data-index="0" />
        <input type="text" class="driver-input bg-purple" data-zone="purple" data-index="1" />
        <input type="text" class="driver-input bg-purple" data-zone="purple" data-index="2" />
        <input type="text" class="driver-input bg-purple" data-zone="purple" data-index="3" />
        <input type="text" class="driver-input bg-purple" data-zone="purple" data-index="4" />
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Escalado responsivo manteniendo el layout exacto
    function updateScale() {
      const viewport = document.getElementById('viewport');
      const w = viewport.clientWidth;
      const scale = Math.min(1, w / 1000);
      viewport.style.setProperty('--scale', scale);
    }
    window.addEventListener('resize', updateScale);
    updateScale();

    // Persistencia de inputs
    document.querySelectorAll('.driver-input').forEach((input) => {
      const key = `d_${input.dataset.zone}_${input.dataset.index}`;
      const saved = localStorage.getItem(key);
      if (saved) input.value = saved;
      input.addEventListener('input', () => localStorage.setItem(key, input.value));
    });

    // Persistencia del turno
    const shiftKey = 'turno';
    const savedShift = localStorage.getItem(shiftKey);
    if (savedShift) {
      const el = document.querySelector(`input[name="turno"][value="${savedShift}"]`);
      if (el) el.checked = true;
    }
    document.querySelectorAll('input[name="turno"]').forEach(r => {
      r.addEventListener('change', () => localStorage.setItem(shiftKey, r.value));
    });

    // Captura (oculta botones para que la imagen quede limpia)
    function capture() {
      const area = document.getElementById('captureArea');
      const btnCapture = document.getElementById('btnCapture');
      const btnInstall = document.getElementById('btnInstall');

      const prevC = btnCapture.style.display;
      const prevI = btnInstall.style.display;
      btnCapture.style.display = 'none';
      btnInstall.style.display = 'none';

      html2canvas(area, { backgroundColor: '#00a859', scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        const date = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
        link.download = `captura-conductores-${date}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).finally(() => {
        btnCapture.style.display = prevC;
        btnInstall.style.display = prevI;
      });
    }

    // Service Worker inline (para que sea PWA)
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE = 'conductores-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil(caches.open(CACHE).then(c => c.addAll(['./'])));
          self.skipWaiting();
        });
        self.addEventListener('activate', (e) => {
          e.waitUntil(self.clients.claim());
        });
        self.addEventListener('fetch', (e) => {
          e.respondWith(
            caches.match(e.request).then(r => r || fetch(e.request).then(res => {
              const copy = res.clone();
              caches.open(CACHE).then(c => c.put(e.request, copy));
              return res;
            }).catch(() => caches.match('./')))
          );
        });
      `;
      const swUrl = 'data:application/javascript;charset=utf-8,' + encodeURIComponent(swCode);
      navigator.serviceWorker.register(swUrl).catch(() => {});
    }

    // Instalación (botón aparece si el navegador lo permite)
    let deferredPrompt;
    const btnInstall = document.getElementById('btnInstall');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.classList.add('show');
    });

    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.classList.remove('show');
    });

    window.addEventListener('appinstalled', () => {
      btnInstall.classList.remove('show');
    });
  </script>
</body>
</html>
